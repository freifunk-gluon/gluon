#!/usr/bin/lua

local uci = require('luci.model.uci').cursor()
local site = require 'gluon.site_config'
local interfaces='/lib/gluon/core/dynamic/interfaces' 

if site.mesh_on_wan then
  uci:section('babeld', 'interface', 'mesh_wan',
    {
      ifname = 'br-wan',
    }
  )

  uci:add_to_set('firewall', 'mesh_babel', 'network', 'wan')
end

pcall( function() 
for interface in io.lines(interfaces) do 
  uci:section('babeld', 'interface', interface, { ifname = interface })
end
end)

uci:add_to_set('firewall', 'mesh_babel', 'network', 'client')
uci:add_to_set('firewall', 'mesh_babel', 'network', 'local_node4')
uci:add_to_set('firewall', 'mesh_babel', 'network', 'local_node6')

uci:save('babeld')
uci:save('firewall')
uci:commit('babeld')
uci:commit('firewall')
