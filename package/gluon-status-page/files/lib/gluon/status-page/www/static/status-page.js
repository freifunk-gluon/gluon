"use strict";!function(){function t(t,e){return t.toFixed(e).replace(/\./,g["."])}function e(e,n){n--;for(var r=e;r>=10&&n>0;r/=10)n--;return t(e,n)}function n(e){return g["%s packets/s"].sprintf(t(e,0))}function r(t,n,r){var i=0;if(void 0===r)return"- ";for(;r>n&&i<t.length-1;)r/=n,i++;return(r=e(r,3))+" "+t[i]}function i(t){return r(["","K","M","G","T"],1024,t)}function o(t){return i(8*t)+"bps"}function a(t){return i(t)+"B"}function c(t,e){return e.split("/").forEach(function(e){t&&(t=t[e])}),t}function u(t,e){var n=new EventSource(t),r={};n.onmessage=function(t){var n=JSON.parse(t.data);e(n,r),r=n},n.onerror=function(){n.close(),window.setTimeout(function(){u(t,e)},3e3)}}function s(t){function e(t,n){return Object.keys(n.peers||{}).forEach(function(e){t.push([e,n.peers[e]])}),Object.keys(n.groups||{}).forEach(function(r){e(t,n.groups[r])}),t}var n=document.getElementById("mesh-vpn");if(!t)return void(n.style.display="none");n.style.display="";for(var r=document.getElementById("mesh-vpn-peers");r.lastChild;)r.removeChild(r.lastChild);var i=e([],t);i.sort(),i.forEach(function(t){var e=document.createElement("tr"),n=document.createElement("th");n.textContent=t[0],e.appendChild(n);var i=document.createElement("td");t[1]?i.textContent=g.connected+" ("+p.time(t[1].established)+")":i.textContent=g["not connected"],e.appendChild(i),r.appendChild(e)})}function f(t,e,n,r){var i=Math.PI/180;t*=i,e*=i,n*=i,r*=i;var o=n-t,a=r-e,c=Math.sin(o/2)*Math.sin(o/2)+Math.sin(a/2)*Math.sin(a/2)*Math.cos(t)*Math.cos(n);return 2*Math.asin(Math.sqrt(c))*6372.8}function l(t){function e(e,n){r.beginPath(),r.fillStyle=t,r.arc(e,n,o,0,2*Math.PI,!1),r.closePath(),r.fill()}var n=document.createElement("canvas"),r=n.getContext("2d"),i=null,o=1.2;return{canvas:n,highlight:!1,resize:function(t,e){try{r.getImageData(0,0,t,e)}catch(t){}n.width=t,n.height=e},draw:function(t,o){var a=o(i);r.clearRect(t,0,5,n.height),a&&e(t,a)},set:function(t){i=t}}}function h(){function t(t,e,n,r){return(e*t+n*(r-t))/r}function e(t,e,n,r){return(1-(t-e)/(n-e))*r}function n(){var e=Math.floor(f.height/40);l.save(),l.lineWidth=.5,l.strokeStyle="rgba(0, 0, 0, 0.25)",l.fillStyle="rgba(0, 0, 0, 0.5)",l.textAlign="end",l.textBaseline="bottom",l.beginPath();for(var n=0;n<e;n++){var r=f.height-40*n;l.moveTo(0,r-.5),l.lineTo(f.width,r-.5);var i=Math.round(t(r,a,c,f.height))+" dBm";l.save(),l.strokeStyle="rgba(255, 255, 255, 0.9)",l.lineWidth=4,l.miterLimit=2,l.strokeText(i,f.width-5,r-2.5),l.fillText(i,f.width-5,r-2.5),l.restore()}l.stroke(),l.strokeStyle="rgba(0, 0, 0, 0.83)",l.lineWidth=1.5,l.strokeRect(.5,.5,f.width-1,f.height-1),l.restore()}function r(){f.width=f.clientWidth,s.forEach(function(t){t.resize(f.width,f.height)})}function i(){if(0!==f.clientWidth){f.width!==f.clientWidth&&r(),l.clearRect(0,0,f.width,f.height);var t=!1;s.forEach(function(e){e.highlight&&(t=!0)}),l.save(),s.forEach(function(n){t&&(l.globalAlpha=.2),n.highlight&&(l.globalAlpha=1),n.draw(u,function(t){return e(t,a,c,f.height)}),l.drawImage(n.canvas,0,0)}),l.restore(),l.save(),l.beginPath(),l.strokeStyle="rgba(255, 180, 0, 0.15)",l.lineWidth=5,l.moveTo(u+2.5,0),l.lineTo(u+2.5,f.height),l.stroke(),n()}}function o(t){t-h>40&&(i(),u=(u+1)%f.width,h=t),window.requestAnimationFrame(o)}var a=-100,c=0,u=0,s=[],f=document.createElement("canvas");f.className="signalgraph",f.height=200;var l=f.getContext("2d");r(),window.addEventListener("resize",i);var h=0;return window.requestAnimationFrame(o),{el:f,addSignal:function(t){s.push(t),t.resize(f.width,f.height)},removeSignal:function(t){s.splice(s.indexOf(t),1)}}}function d(t,e,n,r){function i(){k&&window.clearTimeout(k),k=window.setTimeout(function(){x&&t.signalgraph.removeSignal(x),h.parentNode.removeChild(h),r()},6e4)}function o(t){"::"==t.slice(0,2)&&(t="0"+t),"::"==t.slice(-2)&&(t+="0");var e=t.split(":"),n=e.length,r=[];return e.forEach(function(t,e){if(""===t)for(;n++<=8;)r.push(0);else{if(!/^[a-f0-9]{1,4}$/i.test(t))return;r.push(parseInt(t,16))}}),r}function a(t){var e=o(t);if(e){var n="";return e.forEach(function(t){n+=("0000000000000000"+t.toString(2)).slice(-16)}),n}}function c(t,e){var n;for(n=0;n<t.length&&n<e.length&&t[n]===e[n];n++);return n}function u(t){var e=a(b);if(t&&t[0]){t=t.map(function(t){var n=a(t);if(!n)return[-1];var r=0;return e&&(r=c(e,n)),[r,n,t]}),t.sort(function(t,e){return t[0]<e[0]?1:t[0]>e[0]?-1:t[1]<e[1]?-1:t[1]>e[1]?1:0});var n=t[0][2];return n&&!/^fe80:/i.test(n)?n:void 0}}var s=t.table.firstElementChild,h=t.table.insertRow(),d=h.insertCell();if(t.wireless){var v=document.createElement("span");v.textContent="â¬¤ ",v.style.color=n,d.appendChild(v)}var g=document.createElement("span");g.textContent=e,d.appendChild(g);for(var p={},y=0;y<s.children.length;y++)!function(t){var e=t.getAttribute("data-key");if(e){var n=t.getAttribute("data-suffix")||"",r=h.insertCell();r.textContent="-",p[e]={td:r,suffix:n}}}(s.children[y]);var C,w,E,x;t.wireless&&(C=h.insertCell(),C.textContent="-",w=h.insertCell(),w.textContent="-",E=h.insertCell(),E.textContent="-",x=l(n),t.signalgraph.addSignal(x)),h.onmouseenter=function(){h.classList.add("highlight"),x&&(x.highlight=!0)},h.onmouseleave=function(){h.classList.remove("highlight"),x&&(x.highlight=!1)};var k;return i(),{update_nodeinfo:function(t){var e=u(t.network.addresses);if(e){if("span"===g.nodeName.toLowerCase()){var n=g;g=document.createElement("a"),n.parentNode.replaceChild(g,n)}g.href="http://["+e+"]/"}if(g.textContent=t.hostname,m&&t.location){var r=f(m.latitude,m.longitude,t.location.latitude,t.location.longitude);w.textContent=Math.round(1e3*r)+" m"}i()},update_mesh:function(t){Object.keys(p).forEach(function(e){var n=p[e];n.td.textContent=t[e]+n.suffix}),i()},update_wifi:function(t){C.textContent=t.signal,E.textContent=Math.round(t.inactive/1e3)+" s",h.classList.toggle("inactive",t.inactive>200),x.set(t.inactive>200?null:t.signal),i()}}}function v(t,e,n){function r(){return g[0]||(g=["#396AB1","#DA7C30","#3E9651","#CC2529","#535154","#6B4C9A","#922428","#948B3D"]),g.shift()}function i(t){var e=[],n=t.network.mesh;return Object.keys(n).forEach(function(t){var r=n[t].interfaces;Object.keys(r).forEach(function(t){r[t].forEach(function(t){e.push(t)})})}),e}function o(){if(!l){l=!0;var t=new EventSource("/cgi-bin/dyn/neighbours-nodeinfo?"+encodeURIComponent(e));t.addEventListener("neighbour",function(t){try{var e=JSON.parse(t.data);i(e).forEach(function(t){var n=s[t];if(n){delete v[t];try{n.update_nodeinfo(e)}catch(t){console.error(t)}}})}catch(t){console.error(t)}},!1),t.onerror=function(){t.close(),l=!1,Object.keys(v).forEach(function(t){v[t]>0&&(v[t]--,o())})}}}function a(t){var e=s[t];return e||(v[t]=3,e=s[t]=d(f,t,r(),function(){delete v[t],delete s[t]}),o()),e}var c,s={};n&&(c=h(),t.appendChild(c.el));var f={table:t.firstElementChild,signalgraph:c,ifname:e,wireless:n},l=!1,v={},g=[];return n&&u("/cgi-bin/dyn/stations?"+encodeURIComponent(e),function(t){Object.keys(t).forEach(function(e){var n=t[e];a(e).update_wifi(n)})}),{get_neigh:a}}var g=JSON.parse(document.body.getAttribute("data-translations"));String.prototype.sprintf=function(){var t=0,e=arguments;return this.replace(/%s/g,function(){return e[t++]})};var m,p={id:function(t){return t},decimal:function(e){return t(e,2)},percent:function(t){return g["%s used"].sprintf(e(100*t,3)+"%")},memory:function(t){var e=1-(t.free+t.buffers+t.cached)/t.total;return p.percent(e)},time:function(t){var e=Math.round(t/60),n=Math.floor(e/1440),r=Math.floor(e%1440/60);e=Math.floor(e%60);var i="";return 1===n?i+=g["1 day"]+", ":n>1&&(i+=g["%s days"].sprintf(n)+", "),i+=r+":",e<10&&(i+="0"),i+=e},packetsDiff:function(t,e,r){if(r>0)return n((t-e)/r)},bytesDiff:function(t,e,n){if(n>0)return o((t-e)/n)},bytes:function(t){return a(t)}},b=document.body.getAttribute("data-node-address");try{m=JSON.parse(document.body.getAttribute("data-node-location"))}catch(t){}var y=document.querySelectorAll("[data-statistics]");u("/cgi-bin/dyn/statistics",function(t,e){var n=t.uptime-e.uptime;y.forEach(function(r){var i=r.getAttribute("data-statistics"),o=r.getAttribute("data-format"),a=c(e,i),u=c(t,i);try{var s=p[o](u,a,n);void 0!==s&&(r.textContent=s)}catch(t){console.error(t)}});try{s(t.mesh_vpn)}catch(t){console.error(t)}});var C={};document.querySelectorAll("[data-interface]").forEach(function(t){var e=t.getAttribute("data-interface"),n=(t.getAttribute("data-interface-address"),!!t.getAttribute("data-interface-wireless"));C[e]=v(t,e,n)});var w=document.body.getAttribute("data-mesh-provider");w&&u(w,function(t){Object.keys(t).forEach(function(e){var n=t[e],r=C[n.ifname];r&&r.get_neigh(e).update_mesh(n)})})}();