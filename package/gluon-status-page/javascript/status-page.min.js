"use strict";!function(){const r={},o=JSON.parse(document.body.getAttribute("data-translations"));function i(t,e){return t.toFixed(e).replace(/\./,o["."])}function a(e,n){n--;for(let t=e;10<=t&&0<n;t/=10)n--;return i(e,n)}function c(e){{var n=["","K","M","G","T"],i=1024,o=e;let t=0;if(void 0===o)return"- ";for(;i<o&&t<n.length-1;)o/=i,t++;return(o=a(o,3))+" "+n[t]}}String.prototype.sprintf=function(){let t=0;const e=arguments;return this.replace(/%s/g,function(){return e[t++]})};const l={id:function(t){return t},decimal:function(t){return i(t,2)},percent:function(t){return o["%s used"].sprintf(a(100*t,3)+"%")},memory:function(t){t=1-t.available/t.total;return l.percent(t)},time:function(t){var t=Math.round(t/60),e=Math.floor(t/1440),n=Math.floor(t%1440/60),t=Math.floor(t%60);let i="";return 1===e?i+=o["1 day"]+", ":1<e&&(i+=o["%s days"].sprintf(e)+", "),i+=n+":",t<10&&(i+="0"),i+=t},packetsDiff:function(t,e,n){if(0<n)return t=(t-e)/n,o["%s packets/s"].sprintf(i(t,0))},bytesDiff:function(t,e,n){if(0<n)return c(8*((t-e)/n))+"bps"},bytes:function(t){return c(t)+"B"},neighbour:function(t){if(!t)return"";for(const o in r){var e,n,i=r[o].lookup_neigh(t);if(i)return(e=document.createElement("span")).appendChild(document.createTextNode("via ")),(n=document.createElement("a")).href="http://["+i.get_addr()+"]/",n.textContent=i.get_hostname(),e.appendChild(n),e.appendChild(document.createTextNode(" ("+o+")")),e}return"via "+t+" (unknown iface)"},tq:function(t){return a(100/255*t,1)+"%"}};function s(e,t){return t.split("/").forEach(function(t){e=e&&e[t]}),e}function d(t,e){const n=new EventSource(t);let i={};n.onmessage=function(t){t=JSON.parse(t.data);e(t,i),i=t},n.onerror=function(){n.close(),window.setTimeout(function(){d(t,e)},3e3)}}const x=document.body.getAttribute("data-node-address");let E;try{E=JSON.parse(document.body.getAttribute("data-node-location"))}catch(t){console.error(t)}function t(t){var e=document.getElementById("mesh-vpn");if(t){e.style.display="";const i=document.getElementById("mesh-vpn-peers");for(;i.lastChild;)i.removeChild(i.lastChild);t=function e(n,i){return Object.keys(i.peers||{}).forEach(function(t){n.push([t,i.peers[t]])}),Object.keys(i.groups||{}).forEach(function(t){e(n,i.groups[t])}),n}([],t);t.sort(),t.forEach(function(t){var e=document.createElement("tr"),n=document.createElement("th"),n=(n.textContent=t[0],e.appendChild(n),document.createElement("td"));t[1]&&null!=t[1].established?n.textContent=o.connected+" ("+l.time(t[1].established)+")":n.textContent=o["not connected"],e.appendChild(n),i.appendChild(e)})}else e.style.display="none"}const e=document.querySelectorAll("[data-statistics]");function k(n){const i=document.createElement("canvas"),o=i.getContext("2d",{willReadFrequently:!0});let r=null;return{canvas:i,highlight:!1,resize:function(t,e){let n;try{n=o.getImageData(0,0,t,e)}catch(t){console.error(t)}i.width=t,i.height=e,n&&o.putImageData(n,0,0)},draw:function(t,e){var e=e(r);o.clearRect(t,0,5,i.height),e&&(t=t,e=e,o.beginPath(),o.fillStyle=n,o.arc(t,e,1.2,0,2*Math.PI,!1),o.closePath(),o.fill())},set:function(t){r=t}}}function h(){const l=-100,s=0;let u=0;const d=[],h=document.createElement("canvas"),f=(h.className="signalgraph",h.height=200,h.getContext("2d"));function t(){h.width=h.clientWidth,d.forEach(function(t){t.resize(h.width,h.height)})}function n(){if(0!==h.clientWidth){h.width!==h.clientWidth&&t(),f.clearRect(0,0,h.width,h.height);let e=!1;d.forEach(function(t){t.highlight&&(e=!0)}),f.save(),d.forEach(function(t){e&&(f.globalAlpha=.2),t.highlight&&(f.globalAlpha=1),t.draw(u,function(t){return t=t,e=l,n=s,i=h.height,(1-(t-e)/(n-e))*i;var e,n,i}),f.drawImage(t.canvas,0,0)}),f.restore(),f.save(),f.beginPath(),f.strokeStyle="rgba(255, 180, 0, 0.15)",f.lineWidth=5,f.moveTo(u+2.5,0),f.lineTo(u+2.5,h.height),f.stroke();var n,i,o,r=Math.floor(h.height/40);f.save(),f.lineWidth=.5,f.strokeStyle="rgba(0, 0, 0, 0.25)",f.fillStyle="rgba(0, 0, 0, 0.5)",f.textAlign="end",f.textBaseline="bottom",f.beginPath();for(let t=0;t<r;t++){var a=h.height-40*t,c=(f.moveTo(0,a-.5),f.lineTo(h.width,a-.5),Math.round((n=a,c=l,i=s,o=h.height,(c*n+i*(o-n))/o))+" dBm");f.save(),f.strokeStyle="rgba(255, 255, 255, 0.9)",f.lineWidth=4,f.miterLimit=2,f.strokeText(c,h.width-5,a-2.5),f.fillText(c,h.width-5,a-2.5),f.restore()}f.stroke(),f.strokeStyle="rgba(0, 0, 0, 0.83)",f.lineWidth=1.5,f.strokeRect(.5,.5,h.width-1,h.height-1),f.restore()}}t(),window.addEventListener("resize",n);let i=0;return window.requestAnimationFrame(function t(e){40<e-i&&(n(),u=(u+1)%h.width,i=e),window.requestAnimationFrame(t)}),{el:h,addSignal:function(t){d.push(t),t.resize(h.width,h.height)},removeSignal:function(t){d.splice(d.indexOf(t),1)}}}function f(t,a,e,n){var i=t.tbody.querySelector("tr");const o=t.tbody.insertRow();var r,c,l,s,u,d=o.insertCell();d.setAttribute("data-label",i.children[0].textContent),t.wireless&&((r=document.createElement("span")).textContent="â¬¤ ",r.style.color=e,d.appendChild(r));let h=document.createElement("span");h.textContent=a,d.appendChild(h);const f={};for(let t=0;t<i.children.length;t++)c=i.children[t],u=s=l=void 0,(u=c.getAttribute("data-key"))&&(l=c.getAttribute("data-suffix")||"",(s=o.insertCell()).textContent="-",s.setAttribute("data-label",c.textContent),f[u]={td:s,suffix:l});let g,p,m,b;t.wireless&&((g=o.insertCell()).textContent="-",g.setAttribute("data-label",i.children[Object.keys(f).length+1].textContent),(p=o.insertCell()).textContent="-",p.setAttribute("data-label",i.children[Object.keys(f).length+2].textContent),(m=o.insertCell()).textContent="-",m.setAttribute("data-label",i.children[Object.keys(f).length+3].textContent),b=k(e),t.signalgraph.addSignal(b)),o.onmouseenter=function(){o.classList.add("highlight"),b&&(b.highlight=!0)},o.onmouseleave=function(){o.classList.remove("highlight"),b&&(b.highlight=!1)};let v;function y(){v&&window.clearTimeout(v),v=window.setTimeout(function(){b&&t.signalgraph.removeSignal(b),o.parentNode.removeChild(o),n()},6e4)}function C(t){t=function(t){"::"===(t="::"===t.slice(0,2)?"0"+t:t).slice(-2)&&(t+="0");var e=t.split(":");let n=e.length;var i=[];for(let t=0;t<e.length;t++){var o=e[t];if(""===o)for(;n++<=8;)i.push(0);else{if(!/^[a-f0-9]{1,4}$/i.test(o))return;i.push(parseInt(o,16))}}return i}(t);if(t){let e="";return t.forEach(function(t){e+=("0000000000000000"+t.toString(2)).slice(-16)}),e}}function w(t){const i=C(x);if(t&&t[0])return(t=t.map(function(t){var e=C(t);if(!e)return[-1];let n=0;return[n=i?function(e,n){var i=Math.min(e.length,n.length);for(let t=0;t<i;t++)if(e[t]!==n[t])return t;return i}(i,e):n,e,t]})).sort(function(t,e){return t[0]<e[0]?1:t[0]>e[0]||t[1]<e[1]?-1:t[1]>e[1]?1:0}),(t=t[0][2])&&!/^fe80:/i.test(t)?t:void 0}return y(),{get_hostname:function(){return h.textContent},get_addr:function(){return a},update_nodeinfo:function(t){var e,n,i,o,r;(a=w(t.network.addresses))&&("span"===h.nodeName.toLowerCase()&&(e=h,h=document.createElement("a"),e.parentNode.replaceChild(h,e)),h.href="http://["+a+"]/"),h.textContent=t.hostname,E&&t.location&&(e=E.latitude,n=E.longitude,i=t.location.latitude,t=t.location.longitude,o=Math.PI/180,r=(i*=o)-(e*=o),t=(t*=o)-(n*=o),o=Math.sin(r/2)*Math.sin(r/2)+Math.sin(t/2)*Math.sin(t/2)*Math.cos(e)*Math.cos(i),n=6372.8*(2*Math.asin(Math.sqrt(o))),p.textContent=Math.round(1e3*n)+" m"),y()},update_mesh:function(n){Object.keys(f).forEach(function(t){var e=f[t];e.td.textContent=n[t]+e.suffix}),y()},update_wifi:function(t){g.textContent=t.signal,m.textContent=Math.round(t.inactive/1e3)+" s",o.classList.toggle("inactive",200<t.inactive),b.set(200<t.inactive?null:t.signal),y()}}}function u(t,e,n){const i={};let o;n&&(o=h(),t.appendChild(o.el));const r={tbody:t.querySelector("tbody"),signalgraph:o,ifname:e,wireless:n};let a=!1;const c={};let l=[];function s(){if(!a){a=!0;const t=new EventSource("/cgi-bin/dyn/neighbours-nodeinfo?"+encodeURIComponent(e));t.addEventListener("neighbour",function(t){try{const n=JSON.parse(t.data);!function(t){const n=[],i=t.network.mesh;return Object.keys(i).forEach(function(t){const e=i[t].interfaces;Object.keys(e).forEach(function(t){e[t].forEach(function(t){n.push(t)})})}),n}(n).forEach(function(t){var e=i[t];if(e){delete c[t];try{e.update_nodeinfo(n)}catch(t){console.error(t)}}})}catch(t){console.error(t)}},!1),t.onerror=function(){t.close(),a=!1,Object.keys(c).forEach(function(t){0<c[t]&&(c[t]--,s())})}}}function u(t){let e=i[t];return e||(c[t]=3,e=i[t]=f(r,t,(l=l[0]?l:["#396AB1","#DA7C30","#3E9651","#CC2529","#535154","#6B4C9A","#922428","#948B3D"]).shift(),function(){delete c[t],delete i[t]}),s()),e}return n&&d("/cgi-bin/dyn/stations?"+encodeURIComponent(e),function(n){Object.keys(n).forEach(function(t){var e=n[t];u(t).update_wifi(e)})}),{get_neigh:u,lookup_neigh:function(t){return i[t]}}}d("/cgi-bin/dyn/statistics",function(r,a){const c=r.uptime-a.uptime;e.forEach(function(t){var e=t.getAttribute("data-statistics"),n=t.getAttribute("data-format"),i=s(a,e),e=s(r,e);try{var o=l[n](e,i,c);"object"==typeof o?(t.lastChild&&t.removeChild(t.lastChild),t.appendChild(o)):t.textContent=o}catch(t){console.error(t)}});try{t(r.mesh_vpn)}catch(t){console.error(t)}}),document.querySelectorAll("[data-interface]").forEach(function(t){var e=t.getAttribute("data-interface"),n=!!t.getAttribute("data-interface-wireless");r[e]=u(t,e,n)});var n=document.body.getAttribute("data-mesh-provider");n&&d(n,function(i){Object.keys(i).forEach(function(t){var e=i[t],n=r[e.ifname];n&&n.get_neigh(t).update_mesh(e)})})}();